description: >
  Cycle all Solidus versions and run specs

steps:
  - checkout

  # Solidus v2.5
  - run:
      name: Generate Gemfile.lock
      command: bundle lock
      environment:
        SOLIDUS_BRANCH: v2.5
  - restore_cache:
      keys:
        - gems-v2-ruby-v2-5-6-solidus-v2-5-{{ .Branch }}-{{ checksum "Gemfile.lock" }}
        - gems-v2-ruby-v2-5-6-solidus-v2-5-
  - run:
      command: bundle install --path=vendor/bundle && bundle exec rake
      environment:
        SOLIDUS_BRANCH: v2.5
      name: Runs tests on Solidus v2.5
  - save_cache:
      key: gems-v2-ruby-v2-5-6-solidus-v2-5-{{ .Branch }}-{{ checksum "Gemfile.lock" }}
      paths:
        - vendor/bundle
  - run:
      command: rm Gemfile.lock && rm -fr spec/dummy
      name: Clean up

  # Solidus v2.6
  - run:
      name: Generate Gemfile.lock
      command: bundle lock
      environment:
        SOLIDUS_BRANCH: v2.6
  - restore_cache:
      keys:
        - gems-v2-ruby-v2-5-6-solidus-v2-6-{{ .Branch }}
        - gems-v2-ruby-v2-5-6-solidus-v2-6-
  - run:
      command: bundle install --path=vendor/bundle && bundle exec rake
      environment:
        SOLIDUS_BRANCH: v2.6
      name: Runs tests on Solidus v2.6
  - save_cache:
      key: gems-v2-ruby-v2-5-6-solidus-v2-6-{{ .Branch }}-{{ checksum "Gemfile.lock" }}
      paths:
        - vendor/bundle
  - run:
      command: rm Gemfile.lock && rm -fr spec/dummy
      name: Clean up

  # Solidus v2.7
  - run:
      name: Generate Gemfile.lock
      command: bundle lock
      environment:
        SOLIDUS_BRANCH: v2.7
  - restore_cache:
      keys:
        - gems-v2-ruby-v2-5-6-solidus-v2-7-{{ .Branch }}
        - gems-v2-ruby-v2-5-6-solidus-v2-7-
  - run:
      command: bundle install --path=vendor/bundle && bundle exec rake
      environment:
        SOLIDUS_BRANCH: v2.7
      name: Runs tests on Solidus v2.7
  - save_cache:
      key: gems-v2-ruby-v2-5-6-solidus-v2-7-{{ .Branch }}-{{ checksum "Gemfile.lock" }}
      paths:
        - vendor/bundle
  - run:
      command: rm Gemfile.lock && rm -fr spec/dummy
      name: Clean up

  # Solidus v2.8
  - run:
      name: Generate Gemfile.lock
      command: bundle lock
      environment:
        SOLIDUS_BRANCH: v2.8
  - restore_cache:
      keys:
        - gems-v2-ruby-v2-5-6-solidus-v2-8-{{ .Branch }}
        - gems-v2-ruby-v2-5-6-solidus-v2-8-
  - run:
      command: bundle install --path=vendor/bundle && bundle exec rake
      environment:
        SOLIDUS_BRANCH: v2.8
      name: Runs tests on Solidus v2.8
  - save_cache:
      key: gems-v2-ruby-v2-5-6-solidus-v2-8-{{ .Branch }}-{{ checksum "Gemfile.lock" }}
      paths:
        - vendor/bundle
  - run:
      command: rm Gemfile.lock && rm -fr spec/dummy
      name: Clean up

  # Solidus v2.9
  - run:
      name: Generate Gemfile.lock
      command: bundle lock
      environment:
        SOLIDUS_BRANCH: v2.9
  - restore_cache:
      keys:
        - gems-v2-ruby-v2-5-6-solidus-v2-9-{{ .Branch }}
        - gems-v2-ruby-v2-5-6-solidus-v2-9-
  - run:
      command: bundle install --path=vendor/bundle && bundle exec rake
      environment:
        SOLIDUS_BRANCH: v2.9
      name: Runs tests on Solidus v2.9
  - save_cache:
      key: gems-v2-ruby-v2-5-6-solidus-v2-9-{{ .Branch }}-{{ checksum "Gemfile.lock" }}
      paths:
        - vendor/bundle
  - run:
      command: rm Gemfile.lock && rm -fr spec/dummy
      name: Clean up

  # Solidus master
  - run:
      name: Generate Gemfile.lock
      command: bundle lock
      environment:
        SOLIDUS_BRANCH: master
  - restore_cache:
      keys:
        - gems-v2-ruby-v2-5-6-solidus-master-{{ .Branch }}
        - gems-v2-ruby-v2-5-6-solidus-master-
  - run:
      command: bundle install --path=vendor/bundle && bundle exec rake
      environment:
        SOLIDUS_BRANCH: master
      name: Runs tests on Solidus master
  - save_cache:
      key: gems-v2-ruby-v2-5-6-solidus-master-{{ .Branch }}-{{ checksum "Gemfile.lock" }}
      paths:
        - vendor/bundle
  - run:
      command: rm Gemfile.lock && rm -fr spec/dummy
      name: Clean up
